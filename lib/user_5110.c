#include "stm32f1xx_hal.h"
#include "main.h"
#include "gpio.h"
#include "spi.h"
#include "user_5110.h"

void HAL_SPI_TxCpltCallback(SPI_HandleTypeDef *hspi2){//IMPLEMENTS THE CALLBACK FUNCTION FOR DMA SPI COMPLETE
  LCD_Callback();
}

const unsigned char font6x8[][6] =
{
{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },// sp
{ 0x00, 0x00, 0x00, 0x2f, 0x00, 0x00 },// !
{ 0x00, 0x00, 0x07, 0x00, 0x07, 0x00 },// "
{ 0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14 },// #
{ 0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12 },// $
{ 0x00, 0x23, 0x13, 0x08, 0x64, 0x62 },// %
{ 0x00, 0x36, 0x49, 0x55, 0x22, 0x50 },// &
{ 0x00, 0x00, 0x05, 0x03, 0x00, 0x00 },// '
{ 0x00, 0x00, 0x1c, 0x22, 0x41, 0x00 },// (
{ 0x00, 0x00, 0x41, 0x22, 0x1c, 0x00 },// )
{ 0x00, 0x14, 0x08, 0x3E, 0x08, 0x14 },// *
{ 0x00, 0x08, 0x08, 0x3E, 0x08, 0x08 },// +
{ 0x00, 0x00, 0x00, 0xA0, 0x60, 0x00 },// ,
{ 0x00, 0x08, 0x08, 0x08, 0x08, 0x08 },// -
{ 0x00, 0x00, 0x60, 0x60, 0x00, 0x00 },// .
{ 0x00, 0x20, 0x10, 0x08, 0x04, 0x02 },// /
{ 0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E },// 0
{ 0x00, 0x00, 0x42, 0x7F, 0x40, 0x00 },// 1
{ 0x00, 0x42, 0x61, 0x51, 0x49, 0x46 },// 2
{ 0x00, 0x21, 0x41, 0x45, 0x4B, 0x31 },// 3
{ 0x00, 0x18, 0x14, 0x12, 0x7F, 0x10 },// 4
{ 0x00, 0x27, 0x45, 0x45, 0x45, 0x39 },// 5
{ 0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30 },// 6
{ 0x00, 0x01, 0x71, 0x09, 0x05, 0x03 },// 7
{ 0x00, 0x36, 0x49, 0x49, 0x49, 0x36 },// 8
{ 0x00, 0x06, 0x49, 0x49, 0x29, 0x1E },// 9
{ 0x00, 0x00, 0x36, 0x36, 0x00, 0x00 },// :
{ 0x00, 0x00, 0x56, 0x36, 0x00, 0x00 },// ;
{ 0x00, 0x08, 0x14, 0x22, 0x41, 0x00 },// <
{ 0x00, 0x14, 0x14, 0x14, 0x14, 0x14 },// =
{ 0x00, 0x00, 0x41, 0x22, 0x14, 0x08 },// >
{ 0x00, 0x02, 0x01, 0x51, 0x09, 0x06 },// ?
{ 0x00, 0x32, 0x49, 0x59, 0x51, 0x3E },// @
{ 0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C },// A
{ 0x00, 0x7F, 0x49, 0x49, 0x49, 0x36 },// B
{ 0x00, 0x3E, 0x41, 0x41, 0x41, 0x22 },// C
{ 0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C },// D
{ 0x00, 0x7F, 0x49, 0x49, 0x49, 0x41 },// E
{ 0x00, 0x7F, 0x09, 0x09, 0x09, 0x01 },// F
{ 0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A },// G
{ 0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F },// H
{ 0x00, 0x00, 0x41, 0x7F, 0x41, 0x00 },// I
{ 0x00, 0x20, 0x40, 0x41, 0x3F, 0x01 },// J
{ 0x00, 0x7F, 0x08, 0x14, 0x22, 0x41 },// K
{ 0x00, 0x7F, 0x40, 0x40, 0x40, 0x40 },// L
{ 0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F },// M
{ 0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F },// N
{ 0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E },// O
{ 0x00, 0x7F, 0x09, 0x09, 0x09, 0x06 },// P
{ 0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E },// Q
{ 0x00, 0x7F, 0x09, 0x19, 0x29, 0x46 },// R
{ 0x00, 0x46, 0x49, 0x49, 0x49, 0x31 },// S
{ 0x00, 0x01, 0x01, 0x7F, 0x01, 0x01 },// T
{ 0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F },// U
{ 0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F },// V
{ 0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F },// W
{ 0x00, 0x63, 0x14, 0x08, 0x14, 0x63 },// X
{ 0x00, 0x07, 0x08, 0x70, 0x08, 0x07 },// Y
{ 0x00, 0x61, 0x51, 0x49, 0x45, 0x43 },// Z
{ 0x00, 0x00, 0x7F, 0x41, 0x41, 0x00 },// [
{ 0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55 },// 55
{ 0x00, 0x00, 0x41, 0x41, 0x7F, 0x00 },// ]
{ 0x00, 0x04, 0x02, 0x01, 0x02, 0x04 },// ^
{ 0x00, 0x40, 0x40, 0x40, 0x40, 0x40 },// _
{ 0x00, 0x00, 0x01, 0x02, 0x04, 0x00 },// '
{ 0x00, 0x20, 0x54, 0x54, 0x54, 0x78 },// a
{ 0x00, 0x7F, 0x48, 0x44, 0x44, 0x38 },// b
{ 0x00, 0x38, 0x44, 0x44, 0x44, 0x20 },// c
{ 0x00, 0x38, 0x44, 0x44, 0x48, 0x7F },// d
{ 0x00, 0x38, 0x54, 0x54, 0x54, 0x18 },// e
{ 0x00, 0x08, 0x7E, 0x09, 0x01, 0x02 },// f
{ 0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C },// g
{ 0x00, 0x7F, 0x08, 0x04, 0x04, 0x78 },// h
{ 0x00, 0x00, 0x44, 0x7D, 0x40, 0x00 },// i
{ 0x00, 0x40, 0x80, 0x84, 0x7D, 0x00 },// j
{ 0x00, 0x7F, 0x10, 0x28, 0x44, 0x00 },// k
{ 0x00, 0x00, 0x41, 0x7F, 0x40, 0x00 },// l
{ 0x00, 0x7C, 0x04, 0x18, 0x04, 0x78 },// m
{ 0x00, 0x7C, 0x08, 0x04, 0x04, 0x78 },// n
{ 0x00, 0x38, 0x44, 0x44, 0x44, 0x38 },// o
{ 0x00, 0xFC, 0x24, 0x24, 0x24, 0x18 },// p
{ 0x00, 0x18, 0x24, 0x24, 0x18, 0xFC },// q
{ 0x00, 0x7C, 0x08, 0x04, 0x04, 0x08 },// r
{ 0x00, 0x48, 0x54, 0x54, 0x54, 0x20 },// s
{ 0x00, 0x04, 0x3F, 0x44, 0x40, 0x20 },// t
{ 0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C },// u
{ 0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C },// v
{ 0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C },// w
{ 0x00, 0x44, 0x28, 0x10, 0x28, 0x44 },// x
{ 0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C },// y
{ 0x00, 0x44, 0x64, 0x54, 0x4C, 0x44 },// z
{ 0x14, 0x14, 0x14, 0x14, 0x14, 0x14 }// horiz lines
};
uint8_t testbmap[] ={
0x07, 0xFF, 0xFF, 0xFC, 0xFF, 0xFF, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xEF, 0xFF, 0xFF, 0xFF, 0x7D, 0xBE, 0x4F, 0x37, 0x1B, 0x05, 0x02, 0x01, 0x00, 0x80, 0xC0, 0xE0, 0x60, 0x70, 0xF8, 0xFC, 0xFC, 0x3A, 0x7C, 0x7D, 0x7C, 0x7C, 0x39, 0x09, 0x1D, 0x1B, 0x7B, 0x77, 0xE6, 0x86, 0xA6, 0xC0, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0x30, 0xF0, 0x78, 0xFC, 0x7E, 0x1E, 0x1E, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x00, 0xF9, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
0xE0, 0xF1, 0x9D, 0x7F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xDF, 0x77, 0x1B, 0x04, 0x03, 0x80, 0xC0, 0xF0, 0xF8, 0xFC, 0x9C, 0xC6, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x03, 0x02, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x42, 0x80, 0x9C, 0x9A, 0xE1, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x02, 0x06, 0x20, 0x16, 0x57, 0xC7, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 
0xC1, 0xFD, 0xF8, 0xF9, 0xFE, 0xFC, 0x9D, 0x8F, 0x07, 0x1B, 0x9E, 0xC3, 0xE1, 0xF8, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xBF, 0xFF, 0xFF, 0xEF, 0xF2, 0x18, 0x85, 0x50, 0x50, 0x9C, 0x60, 0x00, 0x00, 0xC0, 0x80, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x4C, 0x00, 0x44, 0xE9, 0x66, 0xEE, 0xF8, 0x60, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x90, 0xA0, 0xD7, 0xFD, 0xFD, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x80, 0x00, 0x03, 0x3F, 0xFF, 0xFF, 0x3F, 0x2F, 0x40, 0x10, 
0x60, 0x71, 0x30, 0x9C, 0xCE, 0xF7, 0xFB, 0xFC, 0xFE, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFF, 0xF7, 0xF0, 0xFA, 0x41, 0x5E, 0x4D, 0x01, 0x00, 0x60, 0x84, 0x88, 0x08, 0x20, 0x30, 0x60, 0x30, 0xE0, 0xF0, 0x20, 0xE0, 0xA0, 0x20, 0x20, 0x20, 0x20, 0x60, 0x20, 0x20, 0x20, 0x20, 0x30, 0x20, 0x30, 0x8C, 0xC0, 0xF3, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x04, 0x76, 0x0B, 0x01, 0x00, 0x00, 0x00, 0x00, 
0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFB, 0xFE, 0xDF, 0xE2, 0xE2, 0xA8, 0x80, 0x80, 0x80, 0x80, 0x02, 0x01, 0x03, 0x83, 0x00, 0x00, 0x02, 0x02, 0x00, 0x00, 0x81, 0x80, 0x80, 0xE0, 0xF8, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xDF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 
0x59, 0x33, 0x6F, 0x9F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0x37, 0x35, 0x60, 0x39, 0x51, 0x30, 0x10, 0x02, 0x66, 0x40, 0x00, 0x30, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x0F, 0x0F, 0x1F, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x00, 0x04, 0x0F, 0x06, 0x0F, 0x13, 0x07, 0x07
};
uint8_t testbmap1[] ={
0x03, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x80, 0x80, 0x44, 0x04, 0x00, 0x02, 0xC2, 0xC2, 0xC8, 0x22, 0x4C, 0x70, 0x74, 0x6C, 0x0E, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x90, 0xC0, 0xC0, 0xC0, 0xC4, 0xCC, 0xE0, 0xF0, 0xFC, 0xFC, 0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0x80, 0x00, 
0x00, 0xC0, 0xE0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xE0, 0x28, 0x28, 0x60, 0x00, 0x16, 0x18, 0xC2, 0xA7, 0xA4, 0x0C, 0x0C, 0x02, 0x02, 0x07, 0x07, 0x00, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x01, 0x01, 0x01, 0x01, 0x03, 0x01, 0x03, 0x03, 0x03, 0x03, 0x07, 0x07, 0x0F, 0x1F, 0x1F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x58, 0xE0, 0xF0, 0xF8, 0xF8, 0xFC, 0xDA, 0xFE, 0xFC, 0xEC, 0x44, 0x50, 0xEA, 0x70, 0x1C, 0x0C, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x90, 0xE0, 0xD0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xE0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x07, 0x03, 0x07, 0x0F, 0x1F, 0x9F, 0xBF, 0xFF, 0xFF, 0xFF, 
0xFF, 0xFF, 0xFF, 0x7F, 0x17, 0x03, 0x05, 0x07, 0x0F, 0x0F, 0x1F, 0x1F, 0x1F, 0x1F, 0x3E, 0x7D, 0xFF, 0xFF, 0xF0, 0x90, 0x80, 0x00, 0x00, 0x00, 0x80, 0xB0, 0xE8, 0xA0, 0xE0, 0xF0, 0xFC, 0xF7, 0xFB, 0xE4, 0xE0, 0xF4, 0x70, 0xB0, 0xF1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x15, 0x59, 0x3B, 0xFF, 0xF0, 0x7C, 0x39, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x82, 0xC0, 0xE8, 0xFB, 0xFF, 
0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x07, 0x0F, 0x1F, 0x1F, 0x3E, 0x7D, 0x4F, 0xCF, 0x9F, 0x9F, 0xFF, 0xFF, 0x9F, 0x9F, 0x1F, 0x0F, 0x0F, 0x0F, 0x39, 0x30, 0x10, 0x30, 0xB0, 0xB0, 0xD0, 0x30, 0x90, 0xD0, 0xF0, 0xF0, 0x78, 0xF8, 0xF8, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xF0, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x03, 0x03, 0x03, 0x02, 0x06, 0x04, 0x04, 0x04, 0x0E, 0x0D, 0x0F, 0x0F, 0x0F, 0x1E, 0x3F, 0x1F, 0x1E, 0x3B, 0x3A, 0x3F, 0x7F, 0x62, 0x60, 0xE0, 0xE4, 0xC4, 0xD8, 0xE8, 0xC0, 0xE8, 0xF0, 0xFC, 0xE8, 0xC0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF8, 0xFC, 0xFC, 0xFE, 0xFE, 0xFF, 0xFF, 0x7F, 0x7F, 0x7F, 0x3F, 0x1F, 0x0F
};
uint8_t spiOK = 0;

/**
 * Initialize LCD.
 */
void LCD_Init(void) {
  LCD_Reset();
  LCD_Write_Command(0x21);//use extended instruction set
  LCD_Write_Command(0xCC);//select contrast
  LCD_Write_Command(0x20);
  LCD_Write_Command(0x0C);
  LCD_Clear();
}

/**
 * Reset LCD.
 */
void LCD_Reset(void) {
  HAL_GPIO_WritePin(LCD_RESET_PORT, LCD_RESET_PIN, GPIO_PIN_RESET);
  HAL_Delay(50);
  HAL_GPIO_WritePin(LCD_RESET_PORT, LCD_RESET_PIN, GPIO_PIN_SET);
}

/**
 * Set LCD cursor position.
 * @param PosX X Position
 * @param PosY Y Position
 */
void LCD_Set_Postion(uint8_t PosX, uint8_t PosY) {
  LCD_Write_Command(0x40 | PosY);
  LCD_Write_Command(0x80 | PosX);
}

/**
 * Clear all contents on LCD.
 */
void LCD_Clear(void) {
  uint8_t t;
  uint8_t k;
  LCD_Set_Postion(0,0);
  for(t=0;t<6;t++)
  {
    for(k=0;k<84;k++)
    {
      LCD_Write_Data(0x00);
    }
  }
}

/**
 * Write a single char to LCD.
 * @param ch char to write.
 */
void LCD_Write_Char(uint8_t ch) {
  uint8_t line;
  ch -= 32;
  for (line=0; line<6; line++) LCD_Write_Data(font6x8[ch][line]);
}

/**
 * Write a string to LCD.
 * @param PosX X start point
 * @param PosY Y start point
 * @param str  string to write.
 */
void LCD_Write_String(uint8_t PosX, uint8_t PosY, char *str) {
  LCD_Set_Postion(PosX, PosY);
  while(* str) {
    LCD_Write_Char(* str);
    str ++;
  }
}

/**
 * Write LCD command to SPI
 * @param cmd command to write.
 */
void LCD_Write_Command(uint8_t cmd) {
  uint32_t tickStart = HAL_GetTick();
  while(!spiOK) {
    if ((HAL_GetTick() - tickStart) > LCD_MAX_TIMEOUT_TICKS) {
      break; // Oops!
    }//magari così è un po piu veloce, ma non è certamente asincrono
  }
  HAL_GPIO_WritePin(LCD_CE_PORT, LCD_CE_PIN, GPIO_PIN_RESET);
  HAL_GPIO_WritePin(LCD_DC_PORT, LCD_DC_PIN, GPIO_PIN_RESET);
  //this should work
  spiOK = 0;
  HAL_SPI_Transmit_DMA(&LCD_SPI_INTERFACE, &cmd, 0x01);
  //if it doesn't uncomment the following and comment the previous
  /*HAL_SPI_Transmit(&LCD_SPI_INTERFACE, &cmd, 0x01,LCD_MAX_TIMEOUT_TICKS);
  HAL_GPIO_WritePin(LCD_CE_PORT, LCD_CE_PIN, GPIO_PIN_SET);
  HAL_GPIO_WritePin(LCD_DC_PORT, LCD_DC_PIN, GPIO_PIN_SET);
  */
  
}

/**
 * Write LCD data to SPI
 * @param data data to write.
 */
void LCD_Write_Data(uint8_t data) {
  uint32_t tickStart = HAL_GetTick();
  while(!spiOK) {
    if ((HAL_GetTick() - tickStart) > LCD_MAX_TIMEOUT_TICKS) {
      break; // Oops!
    }
  }
  HAL_GPIO_WritePin(LCD_CE_PORT, LCD_CE_PIN, GPIO_PIN_RESET);
  HAL_GPIO_WritePin(LCD_DC_PORT, LCD_DC_PIN, GPIO_PIN_SET);
  //this should work
  spiOK = 0;
  HAL_SPI_Transmit_DMA(&LCD_SPI_INTERFACE, &data, 0x01);
  //if it doesn't uncomment the following and comment the previous  
  /*HAL_SPI_Transmit(&LCD_SPI_INTERFACE, &data, 0x01,LCD_MAX_TIMEOUT_TICKS);
  HAL_GPIO_WritePin(LCD_CE_PORT, LCD_CE_PIN, GPIO_PIN_SET);
  HAL_GPIO_WritePin(LCD_DC_PORT, LCD_DC_PIN, GPIO_PIN_RESET);*/
  
}

/**
 * Change LCD contrast
 * @param contrast 0-127 unsigned int.
 */
void LCD_Set_Contrast(uint8_t contrast) {
  LCD_Write_Command(0x21);//use extended instruction set
  LCD_Write_Command(contrast|0b10000000);//select contrast
  LCD_Write_Command(0x20);
}

/**
 * Write a preformatted bitmap of 504 byte
 * @param bmp bitmap, horizzontal addressing print
 */
void LCD_Write_Bitmap(uint8_t * bmp){
  LCD_Clear();
  LCD_Set_Postion(0,0);
  for(int i=0;i<504;i++){
    LCD_Write_Data(bmp[i]);
  }
}
/**
 * Print Lenna test image
 */
void LCD_Test_Image(void){
  LCD_Write_Bitmap(testbmap);
}

/**
 * Print Roberto Sorrentino's face
 */
void LCD_Sorrentino(void){
  LCD_Write_Bitmap(testbmap1);
}

void LCD_Inverse_Mode(void){
  LCD_Write_Command(0x20);
  LCD_Write_Command(0x0D);
}

void LCD_Direct_Mode(void){
  LCD_Write_Command(0x20);
  LCD_Write_Command(0x0C);    
}

/**
 * HAL SPI transfer complete callback
 * @param hspi HAL SPI handler.
 */
void LCD_Callback(void) {
  spiOK = 1;
  HAL_GPIO_WritePin(LCD_CE_PORT, LCD_CE_PIN, GPIO_PIN_SET);
  HAL_GPIO_TogglePin(LCD_DC_PORT, LCD_DC_PIN);
}

/**
 * Power off the LCD
 */
void LCD_Power_Off(void){
  LCD_Clear();
  LCD_Write_Command(0b00100100);
}